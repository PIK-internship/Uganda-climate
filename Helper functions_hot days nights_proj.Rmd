---
title: "R function to derive hot days and nights"
output: html_notebook
---




```{r}
hot_days<-function(source) {
  data_hot_days<-filter(source, tasmax>=35) #change back to source
  # count hot days per lat+lon+year+month
  data_hot_days<-hot_units(data_hot_days)
  return(data_hot_days)
}

hot_nights<-function(source) {
  data_hot_nights<-filter(source, tasmin>=25) 
  # count hot nights per lat+lon+year+month
  data_hot_nights<-hot_units(data_hot_nights)  
  return(data_hot_nights)
}

hot_units<-function(source){
  data_hot_units<-source %>% 
                  group_by(lon,lat, year, month, model) %>% # could summarize per year here already
                  summarize(n = n())

  data_hot_units<- rename(data_hot_units, count=n)          #rename the column to "count"
  
  # take monthly mean across models
  data_hot_units<-aggregate(count ~ lon+lat+year+month, data_hot_units, mean, na.rm=TRUE)
  data_hot_units$count<-as.integer(unlist(data_hot_units$count))     
  # take yearly sum as we want hotdays/year
  data_hot_units<-aggregate(count ~ lon+lat+year, data_hot_units, sum, na.rm=TRUE)
  data_hot_units$count<-as.integer(unlist(data_hot_units$count)) 
  
  # divide into periods and conquer
  data_hot_units_30<-filter(data_hot_units, year<2050)
  data_hot_units_50<-filter(data_hot_units, year>=2050 & year<2090) 
  data_hot_units_90<-filter(data_hot_units, year>=2090)
  
  # take yearly means
  data_hot_units_30<-aggregate(count ~ lon+lat, data_hot_units_30, mean, na.RM=TRUE) 
  data_hot_units_30$count<-as.integer(unlist(data_hot_units_30$count))                    
  
  data_hot_units_50<-aggregate(count ~ lon+lat, data_hot_units_50, mean, na.RM=TRUE)
  data_hot_units_50$count<-as.integer(unlist(data_hot_units_50$count))
  
  data_hot_units_90<-aggregate(count ~ lon+lat, data_hot_units_90, mean, na.RM=TRUE)
  data_hot_units_90$count<-as.integer(unlist(data_hot_units_90$count))                   
  
  # record period
  data_hot_units_30$period<-"2030"
  data_hot_units_50$period<-"2050"
  data_hot_units_90$period<-"2090"
  
  # complete with missing coords
  data_hot_units_30<-completion(points, data_hot_units_30)
  data_hot_units_50<-completion(points, data_hot_units_50)
  data_hot_units_90<-completion(points, data_hot_units_90)
  data_hot_units<-rbind(data_hot_units_30, data_hot_units_50, data_hot_units_90)
  return(data_hot_units)
}

# points: points with yes,no of hits
missing<-function(points) {
  missing_points <- filter(points, check=="No") 
  missing_points<-select(missing_points, lat, lon)
  missing_points$count<-0
  return(missing_points)
}

# source: points, target: scenario with data
checker<-function(source, target) {
  source$check <- ifelse(is.na(match(paste0(source$lat, source$lon),  
                                  paste0(target$lat, target$lon))),"No", "Yes")
  return(source)
}

# source: points, target: data for that period
completion<-function(source, target) { 
  source<-checker(source, target)
  if(ifelse(grepl("No", source$check), "y", "n")=="y") {
     missing_coords<-missing(source)
     missing_coords$period<-target$period[2] # otherwise split and add into the units part
     target<-rbind(target, missing_coords)    
  }
  return(target)
}

pointsGenesis<-function(data) {
  points<-data %>% group_by(lon,lat)  %>%   summarize(n = n())
  points<- select(points, lat, lon)
  return(points)
}
```
